<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Создать заказ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">Управление заказами</a>
        <a href="/orders" class="btn btn-outline-light">Назад к списку</a>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="mb-4">Создать новый заказ</h1>

    <form th:action="@{/orders}" method="post">
        <!-- Выбор продукта -->
        <div class="mb-3">
            <label class="form-label">Выберите продукт *</label>
            <select class="form-select" name="selectedProductName" required
                    id="productSelect" onchange="updateProductInfo()">
                <option value="">-- Выберите продукт --</option>
                <option th:each="product : ${allProducts}"
                        th:value="${product.name}"
                        th:text="${product.name}"
                        th:data-price="${product.currentPrice}"
                        th:data-stock="${product.stockStatus}">
                </option>
            </select>
            <div class="mt-2">
                <small>
                    Цена: <span id="productPrice">-</span> ₽ |
                    Наличие: <span id="productStock">-</span>
                </small>
            </div>
            <div class="mt-1">
                <a href="/products/new" target="_blank" class="text-decoration-none small">
                    ➕ Добавить новый продукт
                </a>
            </div>
        </div>

        <!-- Выбор предприятия -->
        <div class="mb-3">
            <label class="form-label">Выберите предприятие *</label>
            <select class="form-select" name="selectedEnterpriseName" required>
                <option value="">-- Выберите предприятие --</option>
                <option th:each="enterprise : ${allEnterprises}"
                        th:value="${enterprise.name}"
                        th:text="${enterprise.name + ' (Руководитель: ' + enterprise.directorName + ')'}">
                </option>
            </select>
            <div class="mt-1">
                <a href="/enterprises/new" target="_blank" class="text-decoration-none small">
                    ➕ Добавить новое предприятие
                </a>
            </div>
        </div>

        <!-- Статус заказа -->
        <div class="mb-3">
            <label class="form-label">Статус заказа *</label>
            <select class="form-select" name="orderStatus" required>
                <option value="PENDING">В ожидании</option>
                <option value="PROCESSING">В обработке</option>
                <option value="COMPLETED">Завершен</option>
                <option value="CANCELLED">Отменен</option>
            </select>
        </div>

        <!-- Цена -->
        <div class="mb-3">
            <label class="form-label">Цена за единицу *</label>
            <div class="input-group">
                <input type="number" step="0.01" class="form-control"
                       name="currentPriceInOrder" id="priceInput" required>
                <span class="input-group-text">₽</span>
            </div>
            <small class="text-muted">Текущая цена выбранного продукта: <span id="currentProductPrice">-</span> ₽</small>
        </div>

        <!-- Дата заказа -->
        <div class="mb-3">
            <label class="form-label">Дата заказа *</label>
            <input type="date" class="form-control" name="orderDate"
                   th:value="${#temporals.format(order.orderDate, 'yyyy-MM-dd')}" required>
        </div>

        <!-- Кнопки -->
        <div class="mb-3">
            <button type="submit" class="btn btn-success">Создать заказ</button>
            <a href="/orders" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
</div>

<script>
    function updateProductInfo() {
        const select = document.getElementById('productSelect');
        const selectedOption = select.options[select.selectedIndex];

        if (selectedOption.value) {
            const price = parseFloat(selectedOption.dataset.price).toFixed(2);
            const stock = selectedOption.dataset.stock;

            // Обновляем информацию о продукте
            document.getElementById('productPrice').textContent = price;
            document.getElementById('currentProductPrice').textContent = price;

            // Преобразуем статус
            let stockText = '';
            switch(stock) {
                case 'IN_STOCK': stockText = 'В наличии'; break;
                case 'LOW_STOCK': stockText = 'Мало осталось'; break;
                case 'OUT_OF_STOCK': stockText = 'Нет в наличии'; break;
                default: stockText = stock;
            }
            document.getElementById('productStock').textContent = stockText;

            // Автоматически заполняем цену
            document.getElementById('priceInput').value = price;
        } else {
            document.getElementById('productPrice').textContent = '-';
            document.getElementById('productStock').textContent = '-';
            document.getElementById('currentProductPrice').textContent = '-';
            document.getElementById('priceInput').value = '';
        }
    }

    // Установить максимальную дату как сегодня
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[type="date"]').max = today;

        // Инициализировать информацию о продукте, если выбран
        updateProductInfo();
    });
</script>
</body>
</html>